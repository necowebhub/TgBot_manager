# Документация по логированию

## Структура логирования

Проект использует модуль `logging` для отслеживания работы бота и ошибок.

### Файлы логов

Логи сохраняются в директорию `logs/`:

- `bot_YYYY-MM-DD.log` - общий лог всех событий (уровень DEBUG и выше)
- `errors_YYYY-MM-DD.log` - только ошибки (уровень ERROR и выше)

### Уровни логирования

- **DEBUG** - детальная информация для отладки
- **INFO** - общая информация о работе (запуск, завершение операций)
- **WARNING** - предупреждения (некорректные данные, но работа продолжается)
- **ERROR** - ошибки при выполнении операций
- **CRITICAL** - критические ошибки, требующие немедленного внимания

## Конфигурация

### logger_config.py

Централизованная настройка логирования:

```python
from logger_config import setup_logger

logger = setup_logger(__name__)
```

Параметры:
- `name` - имя логгера (обычно `__name__`)
- `log_level` - уровень логирования (по умолчанию "INFO")

## Примеры использования

### Базовое логирование

```python
logger.info("Операция выполнена успешно")
logger.warning("Предупреждение: некорректные данные")
logger.error("Ошибка при выполнении операции")
```

### Логирование с исключениями

```python
try:
    # код
except Exception as e:
    logger.error(f"Ошибка: {e}", exc_info=True)
```

`exc_info=True` добавляет полный traceback в лог.

### Логирование действий пользователей

```python
logger.info(f"Пользователь {user_id} (@{username}) запустил команду /start")
logger.warning(f"Попытка доступа от не-админа: {user_id}")
```

### Логирование операций с БД

```python
logger.info(f"Добавлен новый донат ID {donation_id}: {message[:50]}...")
logger.error(f"Ошибка при сохранении доната: {e}", exc_info=True)
```

## Что логируется

### API (api.py)
- Инициализация API
- Запросы к DonationAlerts
- Ошибки аутентификации
- Rate limits
- Загрузка донатов

### База данных (db.py)
- Инициализация БД
- Добавление/обновление донатов
- Поиск пользователей
- Ошибки SQL

### Обработчики (handlers/)
- Действия пользователей
- Запросы приваток
- Проверка статуса
- Административные команды
- Ошибки валидации

### Планировщик (scheduler.py)
- Запуск задач
- Синхронизация донатов
- Проверка подписок
- Ошибки выполнения

### Проверка подписок (subscription_checker.py)
- Поиск истекших подписок
- Удаление пользователей
- Ошибки Telegram API

## Мониторинг логов

### Просмотр логов в реальном времени

```bash
# Все логи
tail -f logs/bot_$(date +%Y-%m-%d).log

# Только ошибки
tail -f logs/errors_$(date +%Y-%m-%d).log

# С фильтрацией
tail -f logs/bot_*.log | grep ERROR
```

### Поиск ошибок

```bash
# Все ошибки за сегодня
grep ERROR logs/bot_$(date +%Y-%m-%d).log

# Ошибки конкретного пользователя
grep "user_id" logs/bot_*.log | grep ERROR

# Ошибки API
grep "DonationAlerts" logs/errors_*.log
```

### Анализ статистики

```bash
# Количество запросов приваток
grep "запросил ссылку-приглашение" logs/bot_*.log | wc -l

# Количество синхронизаций
grep "Синхронизация завершена" logs/bot_*.log | wc -l

# Количество ошибок
grep ERROR logs/bot_*.log | wc -l
```

## Ротация логов

Логи создаются ежедневно с именем, содержащим дату. Старые логи следует архивировать или удалять:

```bash
# Удалить логи старше 30 дней
find logs/ -name "*.log" -mtime +30 -delete

# Архивировать логи старше 7 дней
find logs/ -name "*.log" -mtime +7 -exec gzip {} \;
```

## Настройка уровня логирования

Для изменения уровня логирования в production:

```python
# В logger_config.py или при вызове
logger = setup_logger(__name__, log_level="WARNING")
```

Или через переменную окружения (нужно добавить поддержку в код):

```bash
export LOG_LEVEL=DEBUG
```

## Рекомендации

1. **INFO** используется для всех важных событий (старт, завершение операций)
2. **WARNING** для ситуаций, требующих внимания, но не критичных
3. **ERROR** для всех ошибок с `exc_info=True` для получения traceback
4. **DEBUG** для детальной отладки (отключить в production)
5. Всегда включайте контекст: ID пользователя, username, суммы, даты

## Troubleshooting

### Логи не создаются

Убедитесь, что директория `logs/` существует и доступна для записи:

```bash
mkdir -p logs
chmod 755 logs
```

### Слишком большие логи

Реализуйте ротацию или измените уровень логирования на WARNING/ERROR в production.

### Не видно ошибок в консоли

Проверьте уровень `console_handler` в `logger_config.py` - должен быть INFO или ниже.