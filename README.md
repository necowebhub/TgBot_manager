# TgBot_manager

## Настройка .env файла

Добавьте в ваш `.env` файл следующие параметры:

```env
BOT_TOKEN=your_bot_token_here
CHANNEL_ID=@your_channel_name  # или -100123456789 (числовой ID)

# Время ежедневной проверки (по умолчанию 12:00)
CHECK_HOUR=12
CHECK_MINUTE=0
```

## Как получить ID канала

1. **Через бота @username_to_id_bot**:
   - Добавьте бота в канал
   - Перешлите любое сообщение из канала боту
   - Он вернет ID канала

2. **Через @getmyid_bot**:
   - Добавьте бота в канал как администратора
   - Напишите любое сообщение в канал
   - Бот покажет ID

3. **Если у канала есть публичное имя**: используйте формат `@channel_name`

## Настройка прав бота в канале

Бот должен быть добавлен в канал как **администратор** со следующими правами:

- ✅ Банить пользователей (Ban users)
- ✅ Добавлять администраторов (Add administrators) - опционально

**Важно**: Без прав администратора бот не сможет удалять пользователей!

### Как добавить бота администратором:

1. Откройте канал → Настройки → Администраторы
2. Нажмите "Добавить администратора"
3. Найдите вашего бота
4. Установите необходимые права
5. Сохраните

## Формат сообщений в донатах

Для корректной работы, в сообщении доната должен быть указан username пользователя. Например:

- `Донат от @username`
- `Спасибо за стрим! username`
- `@username - продлеваю подписку`

Бот будет искать `@username` в тексте сообщения.

## Запуск

```bash
python src/main.py
```

## Функционал

### Автоматическая проверка

- Бот автоматически проверяет подписки **раз в день** в указанное время (по умолчанию 12:00 по МСК)
- Пользователи с истекшей подпиской автоматически удаляются из канала
- Логи выводятся в консоль

### Ручная проверка

Администраторы канала могут запустить проверку вручную командой в канале:

```
/check_subscriptions
```

Бот выполнит проверку немедленно и отчитается о результатах.

## Логика работы

1. Бот получает из базы данных список пользователей, у которых поле `sub` (дата окончания подписки) меньше текущей даты
2. Извлекает username из поля `message`
3. Находит пользователя в канале по username
4. Банит пользователя (удаляет из канала)
5. Опционально: можно сразу разбанить, чтобы он мог вернуться при новой подписке

## Настройка поведения

### Изменить время проверки

В `.env` файле:
```env
CHECK_HOUR=15    # Проверка в 15:00
CHECK_MINUTE=30  # Проверка в 15:30
```

### Разбанить пользователя после удаления

В файле `subscription_checker.py`, раскомментируйте строку:

```python
# await bot.unban_chat_member(channel_id, user_id_to_ban)
```

Это позволит пользователю вернуться по новой ссылке-приглашению после продления подписки.

## Тестирование

1. Запустите бота
2. В канале выполните команду `/check_subscriptions`
3. Проверьте логи в консоли
4. Убедитесь, что пользователи с истекшей подпиской были удалены

## Возможные проблемы

### "Not enough rights"
- Убедитесь, что бот является администратором канала
- Проверьте, что у бота есть права на бан пользователей

### "User not found"
- Пользователь не является участником канала
- Username в базе данных указан неверно
- Пользователь изменил username

### Username не извлекается
- Проверьте формат сообщений в базе данных
- Адаптируйте функцию `extract_username_from_message()` под ваш формат

## Мониторинг

Все действия бота логируются в консоль:

```
[2025-01-21 12:00:00] Начало проверки подписок...
Найдено 5 записей с истекшей подпиской
✓ Пользователь @user1 удален из канала (подписка до 2025-01-20)
✓ Пользователь @user2 удален из канала (подписка до 2025-01-19)
...
=== Результаты проверки ===
Проверено записей: 5
Удалено пользователей: 3
Ошибок: 2
```

## Рекомендации

1. Настройте время проверки на время наименьшей активности канала
2. Протестируйте на тестовом канале перед использованием на основном
3. Регулярно проверяйте логи на предмет ошибок
4. Сохраняйте резервные копии базы данных
5. Информируйте пользователей о необходимости указывать username в донатах